---

title: Multitask Learning Model


keywords: fastai
sidebar: home_sidebar



nb_path: "source_nbs/13_model_fn.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: source_nbs/13_model_fn.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="filter_loss" class="doc_header"><code>filter_loss</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/model_fn.py#L21" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>filter_loss</code>(<strong><code>loss</code></strong>, <strong><code>features</code></strong>, <strong><code>problem</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BertMultiTaskBody" class="doc_header"><code>class</code> <code>BertMultiTaskBody</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/model_fn.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BertMultiTaskBody</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Model</code></p>
</blockquote>
<p>Model to extract bert features and dispatch corresponding rows to each problem_chunk.</p>
<p>for each problem chunk, we extract corresponding features
and hidden features for that problem. The reason behind this
is to save computation for downstream processing.
For example, we have a batch of two instances and they're from
problem a and b respectively:
Input:
[{'input_ids': [1,2,3], 'a_loss_multiplier': 1, 'b_loss_multiplier': 0},
 {'input_ids': [4,5,6], 'a_loss_multiplier': 0, 'b_loss_multiplier': 1}]
Output:
{
  'a': {'input_ids': [1,2,3], 'a_loss_multiplier': 1, 'b_loss_multiplier': 0}
  'b': {'input_ids': [4,5,6], 'a_loss_multiplier': 0, 'b_loss_multiplier': 1}
}</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mtl_body</span> <span class="o">=</span> <span class="n">BertMultiTaskBody</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">set_phase</span><span class="p">(</span><span class="n">TRAIN</span><span class="p">)</span>
<span class="n">features</span><span class="p">,</span> <span class="n">hidden_features</span> <span class="o">=</span> <span class="n">mtl_body</span><span class="p">(</span><span class="n">one_batch_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>404 Client Error: Not Found for url: https://huggingface.co/voidful/albert_chinese_tiny/resolve/main/tf_model.h5
Some weights of the PyTorch model were not used when initializing the TF 2.0 model TFAlbertModel: [&#39;predictions.LayerNorm.bias&#39;, &#39;predictions.LayerNorm.weight&#39;, &#39;predictions.dense.weight&#39;, &#39;predictions.decoder.weight&#39;, &#39;predictions.dense.bias&#39;, &#39;predictions.decoder.bias&#39;, &#39;predictions.bias&#39;]
- This IS expected if you are initializing TFAlbertModel from a PyTorch model trained on another task or with another architecture (e.g. initializing a TFBertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing TFAlbertModel from a PyTorch model that you expect to be exactly identical (e.g. initializing a TFBertForSequenceClassification model from a BertForSequenceClassification model).
All the weights of TFAlbertModel were initialized from the PyTorch model.
If your task is similar to the task the model of the checkpoint was trained on, you can already use TFAlbertModel for predictions without further training.
2021-06-12 22:40:51.719 | CRITICAL | m3tl.embedding_layer.base:__init__:58 - Modal Type id mapping: 
 {
    &#34;array&#34;: 0,
    &#34;cate&#34;: 1,
    &#34;text&#34;: 2
}
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>WARNING: AutoGraph could not transform &lt;bound method Socket.send of &lt;zmq.sugar.socket.Socket object at 0x7f4a1c08b9f0&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module, class, method, function, traceback, frame, or code object was expected, got cython_function_or_method
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>The parameters `output_attentions`, `output_hidden_states` and `use_cache` cannot be updated when calling a model.They have to be set to True/False in the config object (i.e.: `config=XConfig.from_pretrained(&#39;name&#39;, output_attentions=True)`).
The parameter `return_dict` cannot be set in graph mode and will always be set to `True`.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BertMultiTaskTop" class="doc_header"><code>class</code> <code>BertMultiTaskTop</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/model_fn.py#L153" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BertMultiTaskTop</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Model</code></p>
</blockquote>
<p>Model to create top layer, aka classification layer, for each problem.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># top layer takes per-problem features and hidden features</span>
<span class="kn">from</span> <span class="nn">m3tl.utils</span> <span class="kn">import</span> <span class="n">dispatch_features</span>

<span class="n">features_per_problem</span><span class="p">,</span> <span class="n">hidden_features_per_problem</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">problem</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">problem_list</span><span class="p">:</span>
    <span class="n">features_per_problem</span><span class="p">[</span><span class="n">problem</span><span class="p">],</span> <span class="n">hidden_features_per_problem</span><span class="p">[</span><span class="n">problem</span><span class="p">]</span> <span class="o">=</span> <span class="n">dispatch_features</span><span class="p">(</span>
        <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">hidden_feature</span><span class="o">=</span><span class="n">hidden_features</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">TRAIN</span>
    <span class="p">)</span>

<span class="n">input_embeddings</span> <span class="o">=</span> <span class="n">m3tl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_embedding_table_from_model</span><span class="p">(</span>
    <span class="n">mtl_body</span><span class="o">.</span><span class="n">bert</span><span class="o">.</span><span class="n">bert_model</span><span class="p">)</span>
<span class="n">mtl_top</span> <span class="o">=</span> <span class="n">BertMultiTaskTop</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">input_embeddings</span><span class="o">=</span><span class="n">input_embeddings</span><span class="p">)</span>
<span class="n">set_phase</span><span class="p">(</span><span class="n">TRAIN</span><span class="p">)</span>
<span class="n">logit_dict</span> <span class="o">=</span> <span class="n">mtl_top</span><span class="p">((</span><span class="n">features_per_problem</span><span class="p">,</span> <span class="n">hidden_features_per_problem</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-06-12 22:40:58.059 | WARNING  | m3tl.problem_types.masklm:__init__:41 - Share embedding is enabled but hidden_size != embedding_size
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">problem</span><span class="p">,</span> <span class="n">problem_logit</span> <span class="ow">in</span> <span class="n">logit_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># last dim of logits equals to num_classes</span>
    <span class="k">assert</span> <span class="n">problem_logit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="o">.</span><span class="n">get_problem_info</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">info_name</span><span class="o">=</span><span class="s1">&#39;num_classes&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BertMultiTask" class="doc_header"><code>class</code> <code>BertMultiTask</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/model_fn.py#L212" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BertMultiTask</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>Model</code></p>
</blockquote>
<p><code>Model</code> groups layers into an object with training and inference features.</p>
<p>Arguments:
    inputs: The input(s) of the model: a <code>keras.Input</code> object or list of
        <code>keras.Input</code> objects.
    outputs: The output(s) of the model. See Functional API example below.
    name: String, the name of the model.</p>
<p>There are two ways to instantiate a <code>Model</code>:</p>
<p>1 - With the "Functional API", where you start from <code>Input</code>,
you chain layer calls to specify the model's forward pass,
and finally you create your model from inputs and outputs:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
</pre></div>
<p>2 - By subclassing the <code>Model</code> class: in that case, you should define your
layers in <code>__init__</code> and you should implement the model's forward pass
in <code>call</code>.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MyModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
</pre></div>
<p>If you subclass <code>Model</code>, you can optionally have
a <code>training</code> argument (boolean) in <code>call</code>, which you can use to specify
a different behavior in training and inference:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MyModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
</pre></div>
<p>Once the model is created, you can config the model with losses and metrics
with <code>model.compile()</code>, train the model with <code>model.fit()</code>, or use the model
to do prediction with <code>model.predict()</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mtl</span> <span class="o">=</span> <span class="n">BertMultiTask</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">logit_dict</span> <span class="o">=</span> <span class="n">mtl</span><span class="p">(</span><span class="n">one_batch_data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">problem</span><span class="p">,</span> <span class="n">problem_logit</span> <span class="ow">in</span> <span class="n">logit_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># last dim of logits equals to num_classes</span>
    <span class="k">assert</span> <span class="n">problem_logit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="o">.</span><span class="n">get_problem_info</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">problem</span><span class="p">,</span> <span class="n">info_name</span><span class="o">=</span><span class="s1">&#39;num_classes&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>404 Client Error: Not Found for url: https://huggingface.co/voidful/albert_chinese_tiny/resolve/main/tf_model.h5
Some weights of the PyTorch model were not used when initializing the TF 2.0 model TFAlbertModel: [&#39;predictions.LayerNorm.bias&#39;, &#39;predictions.LayerNorm.weight&#39;, &#39;predictions.dense.weight&#39;, &#39;predictions.decoder.weight&#39;, &#39;predictions.dense.bias&#39;, &#39;predictions.decoder.bias&#39;, &#39;predictions.bias&#39;]
- This IS expected if you are initializing TFAlbertModel from a PyTorch model trained on another task or with another architecture (e.g. initializing a TFBertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing TFAlbertModel from a PyTorch model that you expect to be exactly identical (e.g. initializing a TFBertForSequenceClassification model from a BertForSequenceClassification model).
All the weights of TFAlbertModel were initialized from the PyTorch model.
If your task is similar to the task the model of the checkpoint was trained on, you can already use TFAlbertModel for predictions without further training.
2021-06-12 22:41:03.366 | CRITICAL | m3tl.embedding_layer.base:__init__:58 - Modal Type id mapping: 
 {
    &#34;array&#34;: 0,
    &#34;cate&#34;: 1,
    &#34;text&#34;: 2
}
2021-06-12 22:41:03.459 | WARNING  | m3tl.problem_types.masklm:__init__:41 - Share embedding is enabled but hidden_size != embedding_size
The parameters `output_attentions`, `output_hidden_states` and `use_cache` cannot be updated when calling a model.They have to be set to True/False in the config object (i.e.: `config=XConfig.from_pretrained(&#39;name&#39;, output_attentions=True)`).
The parameter `return_dict` cannot be set in graph mode and will always be set to `True`.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mtl</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">mtl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">validation_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-06-12 22:41:04.946 | CRITICAL | __main__:compile:62 - Initial lr: 0.0
2021-06-12 22:41:04.947 | CRITICAL | __main__:compile:63 - Train steps: 0
2021-06-12 22:41:04.947 | CRITICAL | __main__:compile:64 - Warmup steps: 0
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch 1/3
WARNING: AutoGraph could not transform &lt;bound method BertMultiTaskBody.call of &lt;__main__.BertMultiTaskBody object at 0x7f490c151cd0&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: invalid value for &#34;node&#34;: expected &#34;ast.AST&#34;, got &#34;&lt;class &#39;NoneType&#39;&gt;&#34;; to visit lists of nodes, use &#34;visit_block&#34; instead
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>The parameters `output_attentions`, `output_hidden_states` and `use_cache` cannot be updated when calling a model.They have to be set to True/False in the config object (i.e.: `config=XConfig.from_pretrained(&#39;name&#39;, output_attentions=True)`).
The parameter `return_dict` cannot be set in graph mode and will always be set to `True`.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1/1 [==============================] - ETA: 0s - mean_acc: 2.4794 - weibo_fake_cls_acc: 0.5000 - weibo_fake_ner_acc: 0.1143 - BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9767 - BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2088 - BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0114 - BertMultiTaskTop/weibo_masklm/losses/0: 10.0653</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>The parameters `output_attentions`, `output_hidden_states` and `use_cache` cannot be updated when calling a model.They have to be set to True/False in the config object (i.e.: `config=XConfig.from_pretrained(&#39;name&#39;, output_attentions=True)`).
The parameter `return_dict` cannot be set in graph mode and will always be set to `True`.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1/1 [==============================] - 14s 14s/step - mean_acc: 2.4794 - weibo_fake_cls_acc: 0.5000 - weibo_fake_ner_acc: 0.1143 - BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9767 - BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2088 - BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0114 - BertMultiTaskTop/weibo_masklm/losses/0: 10.0653 - val_loss: 14.3237 - val_mean_acc: 0.3214 - val_weibo_fake_cls_acc: 0.5000 - val_weibo_fake_ner_acc: 0.1429 - val_BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9819 - val_BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2721 - val_BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0120 - val_BertMultiTaskTop/weibo_masklm/losses/0: 10.0577
Epoch 2/3
1/1 [==============================] - 1s 717ms/step - mean_acc: 2.4846 - weibo_fake_cls_acc: 0.5000 - weibo_fake_ner_acc: 0.1143 - BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9992 - BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.1767 - BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0816 - BertMultiTaskTop/weibo_masklm/losses/0: 10.0360 - val_loss: 14.3237 - val_mean_acc: 0.3214 - val_weibo_fake_cls_acc: 0.5000 - val_weibo_fake_ner_acc: 0.1429 - val_BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9819 - val_BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2721 - val_BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0120 - val_BertMultiTaskTop/weibo_masklm/losses/0: 10.0577
Epoch 3/3
1/1 [==============================] - 1s 602ms/step - mean_acc: 2.5813 - weibo_fake_cls_acc: 0.5000 - weibo_fake_ner_acc: 0.1429 - BertMultiTaskTop/weibo_fake_cls/losses/0: 1.5078 - BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2698 - BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0046 - BertMultiTaskTop/weibo_masklm/losses/0: 10.0627 - val_loss: 14.3237 - val_mean_acc: 0.3214 - val_weibo_fake_cls_acc: 0.5000 - val_weibo_fake_ner_acc: 0.1429 - val_BertMultiTaskTop/weibo_fake_cls/losses/0: 0.9819 - val_BertMultiTaskTop/weibo_fake_multi_cls/losses/0: 1.2721 - val_BertMultiTaskTop/weibo_fake_ner/losses/0: 2.0120 - val_BertMultiTaskTop/weibo_masklm/losses/0: 10.0577
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">params</span><span class="o">.</span><span class="n">output_body_pooled_hidden</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">params</span><span class="o">.</span><span class="n">output_body_seq_hidden</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">params</span><span class="o">.</span><span class="n">output_mtl_model_hidden</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mtl</span> <span class="o">=</span> <span class="n">BertMultiTask</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">logit_dict</span> <span class="o">=</span> <span class="n">mtl</span><span class="p">(</span><span class="n">one_batch_data</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;pooled&#39;</span> <span class="ow">in</span> <span class="n">logit_dict</span>
<span class="k">assert</span> <span class="s1">&#39;seq&#39;</span> <span class="ow">in</span> <span class="n">logit_dict</span>
<span class="k">assert</span> <span class="s1">&#39;mtl&#39;</span> <span class="ow">in</span> <span class="n">logit_dict</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>404 Client Error: Not Found for url: https://huggingface.co/voidful/albert_chinese_tiny/resolve/main/tf_model.h5
Some weights of the PyTorch model were not used when initializing the TF 2.0 model TFAlbertModel: [&#39;predictions.LayerNorm.bias&#39;, &#39;predictions.LayerNorm.weight&#39;, &#39;predictions.dense.weight&#39;, &#39;predictions.decoder.weight&#39;, &#39;predictions.dense.bias&#39;, &#39;predictions.decoder.bias&#39;, &#39;predictions.bias&#39;]
- This IS expected if you are initializing TFAlbertModel from a PyTorch model trained on another task or with another architecture (e.g. initializing a TFBertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing TFAlbertModel from a PyTorch model that you expect to be exactly identical (e.g. initializing a TFBertForSequenceClassification model from a BertForSequenceClassification model).
All the weights of TFAlbertModel were initialized from the PyTorch model.
If your task is similar to the task the model of the checkpoint was trained on, you can already use TFAlbertModel for predictions without further training.
2021-06-12 22:41:25.001 | CRITICAL | m3tl.embedding_layer.base:__init__:58 - Modal Type id mapping: 
 {
    &#34;array&#34;: 0,
    &#34;cate&#34;: 1,
    &#34;text&#34;: 2
}
2021-06-12 22:41:25.094 | WARNING  | m3tl.problem_types.masklm:__init__:41 - Share embedding is enabled but hidden_size != embedding_size
The parameters `output_attentions`, `output_hidden_states` and `use_cache` cannot be updated when calling a model.They have to be set to True/False in the config object (i.e.: `config=XConfig.from_pretrained(&#39;name&#39;, output_attentions=True)`).
The parameter `return_dict` cannot be set in graph mode and will always be set to `True`.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

