---

title: Read and Write TFRecord


keywords: fastai
sidebar: home_sidebar



nb_path: "source_nbs/06_read_write_tfrecord.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: source_nbs/06_read_write_tfrecord.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Imports">Imports<a class="anchor-link" href="#Imports"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Write-TFRecords">Write TFRecords<a class="anchor-link" href="#Write-TFRecords"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Serialize-Functions">Serialize Functions<a class="anchor-link" href="#Serialize-Functions"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="serialize_fn" class="doc_header"><code>serialize_fn</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L56" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>serialize_fn</code>(<strong><code>features</code></strong>:<code>dict</code>, <strong><code>return_feature_desc</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Make-TFRecord">Make TFRecord<a class="anchor-link" href="#Make-TFRecord"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_tfrecord_local" class="doc_header"><code>make_tfrecord_local</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L126" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_tfrecord_local</code>(<strong><code>data_list</code></strong>, <strong><code>output_dir</code></strong>, <strong><code>serialize_fn</code></strong>, <strong><code>mode</code></strong>=<em><code>'train'</code></em>, <strong><code>example_per_file</code></strong>=<em><code>100000</code></em>, <strong><code>prefix</code></strong>=<em><code>''</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>make tf record and return total number of records</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_tfrecord_pyspark" class="doc_header"><code>make_tfrecord_pyspark</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L172" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_tfrecord_pyspark</code>(<strong><code>data_list</code></strong>, <strong><code>output_dir</code></strong>:<code>str</code>, <strong><code>serialize_fn</code></strong>:<code>Callable</code>, <strong><code>mode</code></strong>=<em><code>'train'</code></em>, <strong><code>example_per_file</code></strong>=<em><code>100000</code></em>, <strong><code>prefix</code></strong>=<em><code>''</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>make tf record and return total number of records with pyspark</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_tfrecord" class="doc_header"><code>make_tfrecord</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L225" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_tfrecord</code>(<strong><code>data_list</code></strong>, <strong><code>output_dir</code></strong>, <strong><code>serialize_fn</code></strong>, <strong><code>mode</code></strong>=<em><code>'train'</code></em>, <strong><code>example_per_file</code></strong>=<em><code>100000</code></em>, <strong><code>prefix</code></strong>=<em><code>''</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Local-write-tfrecord-test">Local write tfrecord test<a class="anchor-link" href="#Local-write-tfrecord-test"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Pyspark-write-tfrecord-test">Pyspark write tfrecord test<a class="anchor-link" href="#Pyspark-write-tfrecord-test"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkContext</span><span class="p">,</span> <span class="n">SparkConf</span>
<span class="n">jar_path</span> <span class="o">=</span> <span class="s1">&#39;/data/m3tl/tmp/tensorflow-hadoop-1.10.0.jar&#39;</span>


<span class="n">conf</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;spark.jars&#39;</span><span class="p">,</span> <span class="n">jar_path</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">m3tl.utils</span> <span class="kn">import</span> <span class="n">set_is_pyspark</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="n">set_is_pyspark</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_features_rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">([</span><span class="n">test_features</span><span class="p">])</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pyspark_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
<span class="n">make_tfrecord</span><span class="p">(</span>
    <span class="n">test_features_rdd</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">test_base</span><span class="o">.</span><span class="n">tmpfiledir</span><span class="p">,</span> <span class="n">serialize_fn</span><span class="o">=</span><span class="n">serialize_fn</span><span class="p">,</span> <span class="n">pyspark_dir</span><span class="o">=</span><span class="n">pyspark_dir</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">m3tl.read_write_tfrecord</span> <span class="kn">import</span> <span class="n">make_feature_desc</span>
<span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_base</span><span class="o">.</span><span class="n">tmpfiledir</span><span class="p">,</span> <span class="s1">&#39;train_feature_desc.json&#39;</span><span class="p">)</span>
<span class="n">feature_desc</span> <span class="o">=</span> <span class="n">make_feature_desc</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)))</span>

<span class="n">tfrecord_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pyspark_dir</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;part-r-00000&#39;</span><span class="p">)</span>

<span class="n">tfr_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">tfrecord_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">feature_desc</span><span class="p">)</span>


<span class="n">tfr_dataset</span> <span class="o">=</span> <span class="n">tfr_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_parse_fn</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tfr_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;float_array&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span>
    <span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Chain-problems-and-write-API">Chain problems and write API<a class="anchor-link" href="#Chain-problems-and-write-API"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="chain_processed_data" class="doc_header"><code>chain_processed_data</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L246" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>chain_processed_data</code>(<strong><code>problem_preproc_gen_dict</code></strong>:<code>Dict</code>[<code>str</code>, <code>Iterator</code>[<code>T_co</code>]])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_tfrecord" class="doc_header"><code>write_tfrecord</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L289" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_tfrecord</code>(<strong><code>params</code></strong>:<a href="/m3tl/1_params.html#Params"><code>Params</code></a>, <strong><code>replace</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Write TFRecord for every problem chunk</p>
<p>Output location: params.tmp_file_dir</p>
<p>Arguments:
    params {params} -- params</p>
<p>Keyword Arguments:
    replace {bool} -- Whether to replace existing tfrecord (default: {False})</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">set_is_pyspark</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_base</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">assign_problem</span><span class="p">(</span>
    <span class="s1">&#39;weibo_fake_ner&amp;weibo_fake_cls|weibo_fake_multi_cls|weibo_masklm|weibo_premask_mlm&#39;</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">test_base</span><span class="o">.</span><span class="n">tmpckptdir</span><span class="p">)</span>
<span class="n">write_tfrecord</span><span class="p">(</span>
    <span class="n">params</span><span class="o">=</span><span class="n">test_base</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">test_base</span><span class="o">.</span><span class="n">tmpfiledir</span><span class="p">,</span> <span class="s1">&#39;weibo_fake_cls_weibo_fake_ner&#39;</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">test_base</span><span class="o">.</span><span class="n">tmpfiledir</span><span class="p">,</span> <span class="s1">&#39;weibo_fake_multi_cls&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-06-19 21:41:03.855 | WARNING  | m3tl.base_params:assign_problem:642 - base_dir and dir_name arguments will be deprecated in the future. Please use model_dir instead.
2021-06-19 21:41:03.856 | WARNING  | m3tl.base_params:prepare_dir:361 - bert_config not exists. will load model from huggingface checkpoint.
2021-06-19 21:41:03.935 | WARNING  | __main__:chain_processed_data:15 - Chaining problems with &amp; may consume a lot of memory if data is not pyspark RDD.
2021-06-19 21:41:03.942 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_fake_cls_weibo_fake_ner/train_00000.tfrecord
2021-06-19 21:41:03.973 | WARNING  | __main__:chain_processed_data:15 - Chaining problems with &amp; may consume a lot of memory if data is not pyspark RDD.
2021-06-19 21:41:03.979 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_fake_cls_weibo_fake_ner/eval_00000.tfrecord
2021-06-19 21:41:04.005 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_fake_multi_cls/train_00000.tfrecord
2021-06-19 21:41:04.030 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_fake_multi_cls/eval_00000.tfrecord
2021-06-19 21:41:04.110 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_masklm/train_00000.tfrecord
2021-06-19 21:41:04.162 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_masklm/eval_00000.tfrecord
2021-06-19 21:41:04.229 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_premask_mlm/train_00000.tfrecord
2021-06-19 21:41:04.297 | DEBUG    | __main__:_write_fn:11 - Writing /tmp/tmpa5zj7lsf/weibo_premask_mlm/eval_00000.tfrecord
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Read-TFRecords">Read TFRecords<a class="anchor-link" href="#Read-TFRecords"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="make_feature_desc" class="doc_header"><code>make_feature_desc</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L340" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>make_feature_desc</code>(<strong><code>feature_desc_dict</code></strong>:<code>dict</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="reshape_tensors_in_dataset" class="doc_header"><code>reshape_tensors_in_dataset</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L351" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>reshape_tensors_in_dataset</code>(<strong><code>example</code></strong>, <strong><code>feature_desc_dict</code></strong>:<code>dict</code>)</p>
</blockquote>
<p>Reshape serialized tensor back to its original shape</p>
<p>Arguments:
    example {Example} -- Example</p>
<p>Returns:
    Example -- Example</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_loss_multiplier" class="doc_header"><code>add_loss_multiplier</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L399" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_loss_multiplier</code>(<strong><code>example</code></strong>, <strong><code>problem</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="set_shape_for_dataset" class="doc_header"><code>set_shape_for_dataset</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L407" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>set_shape_for_dataset</code>(<strong><code>example</code></strong>, <strong><code>feature_desc_dict</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_dummy_features" class="doc_header"><code>get_dummy_features</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L414" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_dummy_features</code>(<strong><code>dataset_dict</code></strong>, <strong><code>feature_desc_dict</code></strong>)</p>
</blockquote>
<p>Get dummy features.
Dummy features are used to make sure every feature dict
at every iteration has the same keys.</p>
<p>Example:
    problem A: {'input_ids': [1,2,3], 'A_label_ids': 1}
    problem B: {'input_ids': [1,2,3], 'B_label_ids': 2}</p>
<p>Then dummy features:
    {'A_label_ids': 0, 'B_label_ids': 0}</p>
<p>At each iteration, we sample a problem, let's say we sampled A
Then:
    feature dict without dummy:
        {'input_ids': [1,2,3], 'A_label_ids': 1}
    feature dict with dummy:
        {'input_ids': [1,2,3], 'A_label_ids': 1, 'B_label_ids':0}</p>
<p>Arguments:
    dataset_dict {dict} -- dict of datasets of all problems</p>
<p>Returns:
    dummy_features -- dict of dummy tensors</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="add_dummy_features_to_dataset" class="doc_header"><code>add_dummy_features_to_dataset</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L460" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>add_dummy_features_to_dataset</code>(<strong><code>example</code></strong>, <strong><code>dummy_features</code></strong>)</p>
</blockquote>
<p>Add dummy features to dataset</p>
<p>feature dict without dummy:
    {'input_ids': [1,2,3], 'A_label_ids': 1}
feature dict with dummy:
    {'input_ids': [1,2,3], 'A_label_ids': 1, 'B_label_ids':0}</p>
<p>Arguments:
    example {data example} -- dataset example
    dummy_features {dict} -- dict of dummy tensors</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_tfrecord" class="doc_header"><code>read_tfrecord</code><a href="https://github.com/JayYip/m3tl/tree/master/m3tl/read_write_tfrecord.py#L478" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_tfrecord</code>(<strong><code>params</code></strong>:<a href="/m3tl/1_params.html#Params"><code>Params</code></a>, <strong><code>mode</code></strong>:<code>str</code>)</p>
</blockquote>
<p>Read and parse TFRecord for every problem</p>
<p>The returned dataset is parsed, reshaped, to_dense tensors
with dummy features.</p>
<p>Arguments:
    params {params} -- params
    mode {str} -- mode, train, eval or predict</p>
<p>Returns:
    dict -- dict with keys: problem name, values: dataset</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Local-read-tfrecord-test">Local read tfrecord test<a class="anchor-link" href="#Local-read-tfrecord-test"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pyspark-read-tfrecord-test">Pyspark read tfrecord test<a class="anchor-link" href="#Pyspark-read-tfrecord-test"> </a></h3><p>NOTE: Test pyspark generated tfrecord</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">m3tl.test_base</span> <span class="kn">import</span> <span class="n">PysparkTestBase</span>
<span class="n">pyspark_test_base</span> <span class="o">=</span> <span class="n">PysparkTestBase</span><span class="p">()</span>

<span class="n">problem_chunk_str</span> <span class="o">=</span> <span class="n">pyspark_test_base</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get_problem_chunk</span><span class="p">(</span><span class="n">as_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">write_tfrecord</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">pyspark_test_base</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pyspark_test_base</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pyspark_output_path</span><span class="p">,</span> <span class="n">problem_chunk_str</span><span class="p">,</span> <span class="s1">&#39;problem_info.txt&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-06-19 21:41:07.551 | INFO     | m3tl.base_params:register_multiple_problems:538 - Adding new problem pyspark_fake_seq_tag, problem type: seq_tag
2021-06-19 21:41:07.552 | INFO     | m3tl.base_params:register_multiple_problems:538 - Adding new problem pyspark_fake_multi_cls, problem type: multi_cls
2021-06-19 21:41:07.552 | INFO     | m3tl.base_params:register_multiple_problems:538 - Adding new problem pyspark_fake_cls, problem type: cls
2021-06-19 21:41:07.553 | WARNING  | m3tl.base_params:assign_problem:642 - base_dir and dir_name arguments will be deprecated in the future. Please use model_dir instead.
2021-06-19 21:41:07.554 | WARNING  | m3tl.base_params:prepare_dir:361 - bert_config not exists. will load model from huggingface checkpoint.
2021-06-19 21:41:13.188 | INFO     | m3tl.utils:set_phase:478 - Setting phase to train
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

